name: Staging Deployment

on:
  pull_request:
    branches:
      - master
    types:
      - opened
      - synchronize
      - labeled
      - reopened
      - ready_for_review

run-name: Staging Deployment - ${{ github.ref_name }}

jobs:
  # Step 2: Run tests (only if we have valid commit)
  testing:
    if: github.event.pull_request.draft == false
    uses: ./.github/workflows/testing.yaml

  # Step 3: Check what changed
  check-changes:
    if: github.event.pull_request.draft == false
    uses: ./.github/workflows/check-changes.yaml
    with:
      comparison-mode: "branch"
      environment: "staging"
      base-branch: "master"

  # Step 4: Read configuration and generate matrices
  prepare-matrix:
    needs: [testing, check-changes]
    uses: ./.github/workflows/prepare-matrix.yaml
    with:
      environment: "staging"
      services-skip-json: ${{ needs.check-changes.outputs.services-skip-json }}

  # Step 5: Display configuration for verification
  display-config:
    needs: [prepare-matrix]
    uses: ./.github/workflows/display-config.yaml
    with:
      build-matrix: ${{ needs.prepare-matrix.outputs.build-matrix }}
      deploy-matrix: ${{ needs.prepare-matrix.outputs.deploy-matrix }}
      environment-config: ${{ needs.prepare-matrix.outputs.environment-config }}

  # Step 6: Version extraction
  version-extraction:
    uses: ./.github/workflows/version-extraction.yaml

  # Step 7: Build and push using dynamic matrix
  build-and-push:
    needs: [testing, prepare-matrix, version-extraction]
    strategy:
      matrix:
        service: ${{ fromJson(needs.prepare-matrix.outputs.build-matrix) }}
    uses: ./.github/workflows/build-and-push.yaml
    with:
      serviceName: ${{ matrix.service.name }}
      image: ${{ matrix.service.image }}
      version: ${{ needs.version-extraction.outputs.version }}
      sha: ${{ github.sha }}
      path: ${{ matrix.service.path }}
      tag: ${{ needs.version-extraction.outputs.version }}.staging
      env: staging
      skip: ${{ matrix.service.skip }}
    secrets: inherit

  # Step 8: Deploy using dynamic matrix
  deploy:
    needs: [prepare-matrix, version-extraction, build-and-push]
    strategy:
      max-parallel: 1
      matrix:
        service: ${{ fromJson(needs.prepare-matrix.outputs.deploy-matrix) }}
    uses: ./.github/workflows/service-kubernetes-deploy.yaml
    with:
      chart: ${{ matrix.service.chart }}
      values: ${{ matrix.service.values }}
      namespace: ${{ matrix.service.namespace }}
      release: ${{ matrix.service.name }}
      path: ${{ matrix.service.path }}
      version: ${{ needs.version-extraction.outputs.version }}
      skip: ${{ matrix.service.skip }}
    secrets: inherit
